<project name="build">

	<macrodef name="compile">
		<attribute name="conf"/>
		<attribute name="version" default="${build.version}"/>
		<element name="additional-classpath" optional="yes"/>
		<sequential>
			<mkdir dir="./bin/@{conf}/java"/>
			
			<!-- if module conf has no ivy dependencies -->
			<mkdir dir="./lib/@{conf}/java/"/>

			<echo>Compiling @{conf} with Java @{version}</echo>
			
			<!-- Compile classes -->
			<javac destdir="./bin/@{conf}/java"
				bootclasspath="${env.JAVA_HOME}/jre/lib/rt.jar"
				debug="true"
				source="@{version}"
				target="@{version}"
				includeantruntime="false">
				
				<src path="./src/@{conf}/java"/>
				<classpath>
					<fileset dir="./lib/@{conf}/java" includes="*.jar"/>
					<path location="${build.classpath}"/>
					<additional-classpath/>
				</classpath>
			</javac>
			
			<!-- Copy any other resources -->
			<copy todir="./bin/@{conf}/java">
				<fileset dir="./src/@{conf}/java" excludes="**/*.java"/>
			</copy>
		</sequential>
	</macrodef>
	
	<target description="Retrieve main dependencies with Ivy."
		name="deps-main">
		
    	<ivy-retrieve conf="main"/>
    </target>
	
	<target description="Retrieve all dependencies with Ivy."
    	name="deps"
    	depends="@before-deps,deps-main,deps-test,@on-deps">
    		
    		<antcall target="@after-deps"/>
    </target>
    	
    <extension-point name="@before-deps"/>
	<extension-point name="@on-deps"/>
	<extension-point name="@after-deps"/>

	<target description="Builds the main project module."
		name="build-main"
		depends="@before-build-main,deps-main,@on-build-main">
		
		<compile conf="main">
			<additional-classpath>
				<path location="${build.classpath.main}"/>
			</additional-classpath>			
		</compile>
		
		<antcall target="@after-build-main"/>
	</target>
	
    <extension-point name="@before-build-main"/>
	<extension-point name="@on-build-main"/>
	<extension-point name="@after-build-main"/>
	
	<target description="Builds all project modules."
		name="build"
		depends="@before-build,build-main,@on-build">
		
		<antcall target="@after-build"/>
	</target>
	
	<extension-point name="@before-build"/>
	<extension-point name="@on-build"/>
	<extension-point name="@after-build"/>

</project>
