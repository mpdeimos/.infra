#!/bin/bash

# smartfile/publish
# =================
#
# Publishes a file using the default build path.
# This is:
# * unstable builds (branches): dev/[repo]/unstable/[branch]/[build_id]-[git_tag]
# * stable build (tags): dev/[repo]/stable/[tag]
#
# Usage
# -----
# publish <file>

set -e

if [[ $TRAVIS_PULL_REQUEST != "false" ]]
then
	echo "Skipping publish in pull request build."
	exit 0;
fi

TAG=`git describe --tags --always --match version/*`
VERSION=${TAG#version/}
	
# Default upload dir, if on a branch.
UPLOAD_DIR="dev/$TRAVIS_REPO_SLUG/unstable/${TRAVIS_BRANCH}/${TRAVIS_BUILD_NUMBER}-${VERSION}"

# If we are building a release, the repo slug is the tag name.
# The tag name is yielded by git describe, iff the current commit is a tag.
if [[ $TAG == $TRAVIS_BRANCH ]]
then
	UPLOAD_DIR="dev/$TRAVIS_REPO_SLUG/stable/${VERSION}"
fi

files=($1)

for file in "${files[@]}"
do
	if [[ ! -f $file ]]
	then
		echo "No valid file: $file"
		exit 1
	fi
	
	echo Publishing $file

	$(dirname $BASH_SOURCE)/upload $file $UPLOAD_DIR
done
